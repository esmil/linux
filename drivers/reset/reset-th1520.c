// SPDX-License-Identifier: GPL-2.0-or-later
/*
 * Reset driver for the T-Head TH1520 SoC
 *
 * Copyright (C) 2024 Emil Renner Berthing <emil.renner.berthing@canonical.com>
 */

#include <linux/io.h>
#include <linux/mod_devicetable.h>
#include <linux/platform_device.h>
#include <linux/property.h>
#include <linux/reset-controller.h>
#include <linux/spinlock.h>

#include <dt-bindings/reset/thead,th1520-reset.h>

struct th1520_reset {
	struct reset_controller_dev rcdev;
	/* protect registers against concurrent read-modify-write */
	spinlock_t lock;
	void __iomem *base;
	const u32 *resets;
};

struct th1520_reset_subsys {
	const u32 *resets;
	u32 nr_resets;
};

static inline struct th1520_reset *
th1520_reset_from(struct reset_controller_dev *rcdev)
{
	return container_of(rcdev, struct th1520_reset, rcdev);
}

#define TH1520_RESET_ENTRY(name, offset, mask)	[name] = (((offset) << 6) | (mask))

static void __iomem *th1520_reset_reg(struct th1520_reset *rc, unsigned int id)
{
	return rc->base + ((rc->resets[id] & ~0xffU) >> 6);
}

static u32 th1520_reset_mask(struct th1520_reset *rc, unsigned int id)
{
	return rc->resets[id] & 0xffU;
}

static const u32 th1520_aon_resets[] = {
	TH1520_RESET_ENTRY(AONRST_RTC_APB,		0x0014, 0x01),
	TH1520_RESET_ENTRY(AONRST_RTC_REFERENCE,	0x0014, 0x02),
	TH1520_RESET_ENTRY(AONRST_RTC,			0x0014, 0x03),
	TH1520_RESET_ENTRY(AONRST_AOGPIO_DEBOUNCE,	0x0018, 0x01),
	TH1520_RESET_ENTRY(AONRST_AOGPIO_APB,		0x0018, 0x02),
	TH1520_RESET_ENTRY(AONRST_AOGPIO,		0x0018, 0x03),
	TH1520_RESET_ENTRY(AONRST_AOI2C,		0x001c, 0x01),
	TH1520_RESET_ENTRY(AONRST_PVTC,			0x0020, 0x01),
	TH1520_RESET_ENTRY(AONRST_E902_CORE,		0x0024, 0x01),
	TH1520_RESET_ENTRY(AONRST_E902_HAD,		0x0024, 0x02),
	TH1520_RESET_ENTRY(AONRST_E902,			0x0024, 0x03),
	TH1520_RESET_ENTRY(AONRST_AOTIMER_APB,		0x0028, 0x01),
	TH1520_RESET_ENTRY(AONRST_AOTIMER_CORE,		0x0028, 0x02),
	TH1520_RESET_ENTRY(AONRST_AOTIMER,		0x0028, 0x03),
	TH1520_RESET_ENTRY(AONRST_AOWDT,		0x002c, 0x01),
	TH1520_RESET_ENTRY(AONRST_APSYS,		0x0030, 0x01),
	TH1520_RESET_ENTRY(AONRST_NPUSYS,		0x0034, 0x01),
	TH1520_RESET_ENTRY(AONRST_DDRSYS,		0x0038, 0x01),
	TH1520_RESET_ENTRY(AONRST_AP2CP,		0x003c, 0x01),
	TH1520_RESET_ENTRY(AONRST_CP2AP,		0x003c, 0x02),
	TH1520_RESET_ENTRY(AONRST_CP2SRAM,		0x003c, 0x04),
	TH1520_RESET_ENTRY(AONRST_AUDIOSYS_CORE,	0x003c, 0x08),
	TH1520_RESET_ENTRY(AONRST_AUDIOSYS_IOPMP,	0x003c, 0x10),
	TH1520_RESET_ENTRY(AONRST_AUDIOSYS,		0x003c, 0x20),
	TH1520_RESET_ENTRY(AONRST_BISR_SRAM,		0x0050, 0x01),
	TH1520_RESET_ENTRY(AONRST_BISR_L2,		0x0050, 0x02),
	TH1520_RESET_ENTRY(AONRST_BISR,			0x0050, 0x03),
	TH1520_RESET_ENTRY(AONRST_DSP0,			0x0054, 0x01),
	TH1520_RESET_ENTRY(AONRST_DSP1,			0x0058, 0x01),
	TH1520_RESET_ENTRY(AONRST_GPU,			0x005c, 0x01),
	TH1520_RESET_ENTRY(AONRST_VDEC,			0x0060, 0x01),
	TH1520_RESET_ENTRY(AONRST_VENC,			0x0064, 0x01),
	TH1520_RESET_ENTRY(AONRST_ADC,			0x0070, 0x01),
	TH1520_RESET_ENTRY(AONRST_AUDGPIO_DEBOUNCE,	0x0074, 0x01),
	TH1520_RESET_ENTRY(AONRST_AUDGPIO_APB,		0x0074, 0x02),
	TH1520_RESET_ENTRY(AONRST_AUDGPIO,		0x0074, 0x03),
	TH1520_RESET_ENTRY(AONRST_AOUART_INTERFACE,	0x0078, 0x01),
	TH1520_RESET_ENTRY(AONRST_AOUART_APB,		0x0078, 0x02),
	TH1520_RESET_ENTRY(AONRST_AOUART,		0x0078, 0x03),
	TH1520_RESET_ENTRY(AONRST_SE,			0x0160, 0x01),
	TH1520_RESET_ENTRY(AONRST_SRAM_AXI_PORT0,	0x11f4, 0x01),
	TH1520_RESET_ENTRY(AONRST_SRAM_AXI_PORT1,	0x11f4, 0x02),
	TH1520_RESET_ENTRY(AONRST_SRAM_AXI_PORT2,	0x11f4, 0x04),
	TH1520_RESET_ENTRY(AONRST_SRAM_AXI_PORT3,	0x11f4, 0x08),
	TH1520_RESET_ENTRY(AONRST_SRAM_AXI_PORT4,	0x11f4, 0x10),
	TH1520_RESET_ENTRY(AONRST_SRAM_AXI_CORE,	0x11f4, 0x40),
	TH1520_RESET_ENTRY(AONRST_SRAM_AXI,		0x11f4, 0x5f),
};

static const struct th1520_reset_subsys th1520_aon_subsys = {
	.resets = th1520_aon_resets,
	.nr_resets = ARRAY_SIZE(th1520_aon_resets),
};

static const u32 th1520_ap_resets[] = {
	TH1520_RESET_ENTRY(APRST_C910_BROM,		0x0000, 0x01),
	TH1520_RESET_ENTRY(APRST_C910_TOP,		0x0004, 0x01),
	TH1520_RESET_ENTRY(APRST_C910_CORE0,		0x0004, 0x02),
	TH1520_RESET_ENTRY(APRST_C910_CORE1,		0x0004, 0x04),
	TH1520_RESET_ENTRY(APRST_C910_CORE2,		0x0004, 0x08),
	TH1520_RESET_ENTRY(APRST_C910_CORE3,		0x0004, 0x10),
	TH1520_RESET_ENTRY(APRST_CHIP_DBG_CORE,		0x000c, 0x01),
	TH1520_RESET_ENTRY(APRST_CHIP_DBG_AXI,		0x000c, 0x02),
	TH1520_RESET_ENTRY(APRST_CHIP_DBG,		0x000c, 0x03),
	TH1520_RESET_ENTRY(APRST_AXI4_CPUSYS2_AXI,	0x0010, 0x01),
	TH1520_RESET_ENTRY(APRST_AXI4_CPUSYS2_APB,	0x0010, 0x02),
	TH1520_RESET_ENTRY(APRST_AXI4_CPUSYS2,		0x0010, 0x03),
	TH1520_RESET_ENTRY(APRST_X2X_CPUSYS,		0x0014, 0x01),
	TH1520_RESET_ENTRY(APRST_X2H_CPUSYS,		0x0018, 0x01),
	TH1520_RESET_ENTRY(APRST_AHB2_CPUSYS,		0x001c, 0x01),
	TH1520_RESET_ENTRY(APRST_APB3_CPUSYS,		0x0020, 0x01),
	TH1520_RESET_ENTRY(APRST_MBOX0,			0x0024, 0x01),
	TH1520_RESET_ENTRY(APRST_MBOX1,			0x0028, 0x01),
	TH1520_RESET_ENTRY(APRST_MBOX2,			0x002c, 0x01),
	TH1520_RESET_ENTRY(APRST_MBOX3,			0x0030, 0x01),
	TH1520_RESET_ENTRY(APRST_WDT0,			0x0034, 0x01),
	TH1520_RESET_ENTRY(APRST_WDT1,			0x0038, 0x01),
	TH1520_RESET_ENTRY(APRST_TIMER0_APB,		0x003c, 0x01),
	TH1520_RESET_ENTRY(APRST_TIMER0_CORE,		0x003c, 0x02),
	TH1520_RESET_ENTRY(APRST_TIMER0,		0x003c, 0x03),
	TH1520_RESET_ENTRY(APRST_TIMER1_APB,		0x0040, 0x01),
	TH1520_RESET_ENTRY(APRST_TIMER1_CORE,		0x0040, 0x02),
	TH1520_RESET_ENTRY(APRST_TIMER1,		0x0040, 0x03),
	TH1520_RESET_ENTRY(APRST_PERISYS_AHB,		0x0044, 0x01),
	TH1520_RESET_ENTRY(APRST_PERISYS_APB1,		0x0048, 0x01),
	TH1520_RESET_ENTRY(APRST_PERISYS_APB2,		0x004c, 0x01),
	TH1520_RESET_ENTRY(APRST_GMAC0_APB,		0x0068, 0x01),
	TH1520_RESET_ENTRY(APRST_GMAC0_AHB,		0x0068, 0x02),
	TH1520_RESET_ENTRY(APRST_GMAC0_CLKGEN,		0x0068, 0x04),
	TH1520_RESET_ENTRY(APRST_GMAC0_AXI,		0x0068, 0x08),
	TH1520_RESET_ENTRY(APRST_GMAC0,			0x0068, 0x0f),
	TH1520_RESET_ENTRY(APRST_UART0_APB,		0x0070, 0x01),
	TH1520_RESET_ENTRY(APRST_UART0_INTERFACE,	0x0070, 0x02),
	TH1520_RESET_ENTRY(APRST_UART0,			0x0070, 0x03),
	TH1520_RESET_ENTRY(APRST_UART1_APB,		0x0074, 0x01),
	TH1520_RESET_ENTRY(APRST_UART1_INTERFACE,	0x0074, 0x02),
	TH1520_RESET_ENTRY(APRST_UART1,			0x0074, 0x03),
	TH1520_RESET_ENTRY(APRST_UART2_APB,		0x0078, 0x01),
	TH1520_RESET_ENTRY(APRST_UART2_INTERFACE,	0x0078, 0x02),
	TH1520_RESET_ENTRY(APRST_UART2,			0x0078, 0x03),
	TH1520_RESET_ENTRY(APRST_UART3_APB,		0x007c, 0x01),
	TH1520_RESET_ENTRY(APRST_UART3_INTERFACE,	0x007c, 0x02),
	TH1520_RESET_ENTRY(APRST_UART3,			0x007c, 0x03),
	TH1520_RESET_ENTRY(APRST_UART4_APB,		0x0080, 0x01),
	TH1520_RESET_ENTRY(APRST_UART4_INTERFACE,	0x0080, 0x02),
	TH1520_RESET_ENTRY(APRST_UART4,			0x0080, 0x03),
	TH1520_RESET_ENTRY(APRST_UART5_APB,		0x0084, 0x01),
	TH1520_RESET_ENTRY(APRST_UART5_INTERFACE,	0x0084, 0x02),
	TH1520_RESET_ENTRY(APRST_UART5,			0x0084, 0x03),
	TH1520_RESET_ENTRY(APRST_QSPI0_INTERFACE,	0x008c, 0x01),
	TH1520_RESET_ENTRY(APRST_QSPI0_APB,		0x008c, 0x02),
	TH1520_RESET_ENTRY(APRST_QSPI0,			0x008c, 0x03),
	TH1520_RESET_ENTRY(APRST_QSPI1_INTERFACE,	0x0090, 0x01),
	TH1520_RESET_ENTRY(APRST_QSPI1_APB,		0x0090, 0x02),
	TH1520_RESET_ENTRY(APRST_QSPI1,			0x0090, 0x03),
	TH1520_RESET_ENTRY(APRST_SPI_INTERFACE,		0x0094, 0x01),
	TH1520_RESET_ENTRY(APRST_SPI_APB,		0x0094, 0x02),
	TH1520_RESET_ENTRY(APRST_SPI,			0x0094, 0x03),
	TH1520_RESET_ENTRY(APRST_I2C0_APB,		0x0098, 0x01),
	TH1520_RESET_ENTRY(APRST_I2C0_CORE,		0x0098, 0x02),
	TH1520_RESET_ENTRY(APRST_I2C0,			0x0098, 0x03),
	TH1520_RESET_ENTRY(APRST_I2C1_APB,		0x009c, 0x01),
	TH1520_RESET_ENTRY(APRST_I2C1_CORE,		0x009c, 0x02),
	TH1520_RESET_ENTRY(APRST_I2C1,			0x009c, 0x03),
	TH1520_RESET_ENTRY(APRST_I2C2_APB,		0x00a0, 0x01),
	TH1520_RESET_ENTRY(APRST_I2C2_CORE,		0x00a0, 0x02),
	TH1520_RESET_ENTRY(APRST_I2C2,			0x00a0, 0x03),
	TH1520_RESET_ENTRY(APRST_I2C3_APB,		0x00a4, 0x01),
	TH1520_RESET_ENTRY(APRST_I2C3_CORE,		0x00a4, 0x02),
	TH1520_RESET_ENTRY(APRST_I2C3,			0x00a4, 0x03),
	TH1520_RESET_ENTRY(APRST_I2C4_APB,		0x00a8, 0x01),
	TH1520_RESET_ENTRY(APRST_I2C4_CORE,		0x00a8, 0x02),
	TH1520_RESET_ENTRY(APRST_I2C4,			0x00a8, 0x03),
	TH1520_RESET_ENTRY(APRST_I2C5_APB,		0x00ac, 0x01),
	TH1520_RESET_ENTRY(APRST_I2C5_CORE,		0x00ac, 0x02),
	TH1520_RESET_ENTRY(APRST_I2C5,			0x00ac, 0x03),
	TH1520_RESET_ENTRY(APRST_GPIO0_DEBOUNCE,	0x00b0, 0x01),
	TH1520_RESET_ENTRY(APRST_GPIO0_APB,		0x00b0, 0x02),
	TH1520_RESET_ENTRY(APRST_GPIO0,			0x00b0, 0x03),
	TH1520_RESET_ENTRY(APRST_GPIO1_DEBOUNCE,	0x00b4, 0x01),
	TH1520_RESET_ENTRY(APRST_GPIO1_APB,		0x00b4, 0x02),
	TH1520_RESET_ENTRY(APRST_GPIO1,			0x00b4, 0x03),
	TH1520_RESET_ENTRY(APRST_GPIO2_DEBOUNCE,	0x00b8, 0x01),
	TH1520_RESET_ENTRY(APRST_GPIO2_APB,		0x00b8, 0x02),
	TH1520_RESET_ENTRY(APRST_GPIO2,			0x00b8, 0x03),
	TH1520_RESET_ENTRY(APRST_PWM_COUNTER,		0x00c0, 0x01),
	TH1520_RESET_ENTRY(APRST_PWM_APB,		0x00c0, 0x02),
	TH1520_RESET_ENTRY(APRST_PWM,			0x00c0, 0x03),
	TH1520_RESET_ENTRY(APRST_PADCTRL0_APSYS,	0x00c4, 0x01),
	TH1520_RESET_ENTRY(APRST_CPU2PERI_X2H,		0x00cc, 0x02),
	TH1520_RESET_ENTRY(APRST_AXI4_CFG_BUS,		0x00d4, 0x01),
	TH1520_RESET_ENTRY(APRST_CPU2CFG_APB,		0x00d8, 0x01),
	TH1520_RESET_ENTRY(APRST_CPU2CFG_X2H,		0x00d8, 0x02),
	TH1520_RESET_ENTRY(APRST_CPU2CFG_X2X,		0x00dc, 0x01),
	TH1520_RESET_ENTRY(APRST_CPU2AON_X2H,		0x00e4, 0x01),
	TH1520_RESET_ENTRY(APRST_AXI4_CPUSYS1_AXI,	0x00f8, 0x01),
	TH1520_RESET_ENTRY(APRST_AXI4_CPUSYS1_APB,	0x00f8, 0x02),
	TH1520_RESET_ENTRY(APRST_AXI4_CPUSYS1,		0x00f8, 0x03),
	TH1520_RESET_ENTRY(APRST_AON2CPU_A2X,		0x00fc, 0x01),
	TH1520_RESET_ENTRY(APRST_NPUSYS_AXI_AXI,	0x0128, 0x01),
	TH1520_RESET_ENTRY(APRST_NPUSYS_AXI_APB,	0x0128, 0x02),
	TH1520_RESET_ENTRY(APRST_NPUSYS_AXI,		0x0128, 0x03),
	TH1520_RESET_ENTRY(APRST_CPU2VP_X2P,		0x012c, 0x01),
	TH1520_RESET_ENTRY(APRST_CPU2VI_X2H,		0x0138, 0x01),
	TH1520_RESET_ENTRY(APRST_BMU_C910_AXI,		0x0148, 0x01),
	TH1520_RESET_ENTRY(APRST_BMU_C910_APB,		0x0148, 0x02),
	TH1520_RESET_ENTRY(APRST_BMU_C910,		0x0148, 0x03),
	TH1520_RESET_ENTRY(APRST_DMAC_CPUSYS_AXI,	0x014c, 0x01),
	TH1520_RESET_ENTRY(APRST_DMAC_CPUSYS_AHB,	0x014c, 0x02),
	TH1520_RESET_ENTRY(APRST_DMAC_CPUSYS,		0x014c, 0x03),
	TH1520_RESET_ENTRY(APRST_SPINLOCK,		0x0178, 0x01),
	TH1520_RESET_ENTRY(APRST_CFG2TEE_X2H,		0x0188, 0x01),
	TH1520_RESET_ENTRY(APRST_DSMART,		0x018c, 0x01),
	TH1520_RESET_ENTRY(APRST_GPIO3_DEBOUNCE,	0x01a8, 0x01),
	TH1520_RESET_ENTRY(APRST_GPIO3_APB,		0x01a8, 0x02),
	TH1520_RESET_ENTRY(APRST_GPIO3,			0x01a8, 0x03),
	TH1520_RESET_ENTRY(APRST_I2S,			0x01ac, 0x01),
	TH1520_RESET_ENTRY(APRST_IMG_NNA,		0x01b0, 0x01),
	TH1520_RESET_ENTRY(APRST_PERI_APB3,		0x01dc, 0x01),
	TH1520_RESET_ENTRY(APRST_PERI2PERI1_APB,	0x01dc, 0x02),
	TH1520_RESET_ENTRY(APRST_VP_SUBSYS_APB,		0x01ec, 0x01),
	TH1520_RESET_ENTRY(APRST_PERISYS_APB4,		0x01f8, 0x01),
	TH1520_RESET_ENTRY(APRST_GMAC1_APB,		0x0204, 0x01),
	TH1520_RESET_ENTRY(APRST_GMAC1_AHB,		0x0204, 0x02),
	TH1520_RESET_ENTRY(APRST_GMAC1_CLKGEN,		0x0204, 0x04),
	TH1520_RESET_ENTRY(APRST_GMAC1_AXI,		0x0204, 0x08),
	TH1520_RESET_ENTRY(APRST_GMAC1,			0x0204, 0x0f),
	TH1520_RESET_ENTRY(APRST_GMAC_AXI_AXI,		0x0208, 0x01),
	TH1520_RESET_ENTRY(APRST_GMAC_AXI_APB,		0x0208, 0x02),
	TH1520_RESET_ENTRY(APRST_GMAC_AXI,		0x0208, 0x03),
	TH1520_RESET_ENTRY(APRST_PADCTRL1_APSYS,	0x020c, 0x01),
	TH1520_RESET_ENTRY(APRST_VOSYS_AXI_AXI,		0x0210, 0x01),
	TH1520_RESET_ENTRY(APRST_VOSYS_AXI_APB,		0x0210, 0x02),
	TH1520_RESET_ENTRY(APRST_VOSYS_AXI,		0x0210, 0x03),
	TH1520_RESET_ENTRY(APRST_VOBUS2NPUBUS_X2X,	0x0214, 0x01),
	TH1520_RESET_ENTRY(APRST_MISC2VP_X2X,		0x0218, 0x01),
	TH1520_RESET_ENTRY(APRST_DSP_SUBSYS,		0x0220, 0x01),
	TH1520_RESET_ENTRY(APRST_VI_SUBSYS,		0x0220, 0x02),
	TH1520_RESET_ENTRY(APRST_VO_SUBSYS,		0x0220, 0x04),
	TH1520_RESET_ENTRY(APRST_VP_SUBSYS,		0x0220, 0x08),
};

static const struct th1520_reset_subsys th1520_ap_subsys = {
	.resets = th1520_ap_resets,
	.nr_resets = ARRAY_SIZE(th1520_ap_resets),
};

static int th1520_reset_update(struct reset_controller_dev *rcdev,
			       unsigned long id, bool assert)
{
	struct th1520_reset *rc = th1520_reset_from(rcdev);
	void __iomem *reg = th1520_reset_reg(rc, id);
	u32 mask = th1520_reset_mask(rc, id);
	u32 value;

	scoped_guard(spinlock_irqsave, &rc->lock) {
		value = readl_relaxed(reg);
		if (assert)
			value &= ~mask;
		else
			value |= mask;
		writel_relaxed(value, reg);
	}
	return 0;
}

static int th1520_reset_assert(struct reset_controller_dev *rcdev,
			       unsigned long id)
{
	return th1520_reset_update(rcdev, id, true);
}

static int th1520_reset_deassert(struct reset_controller_dev *rcdev,
				 unsigned long id)
{
	return th1520_reset_update(rcdev, id, false);
}

static int th1520_reset_reset(struct reset_controller_dev *rcdev,
			      unsigned long id)
{
	int ret;

	ret = th1520_reset_assert(rcdev, id);
	if (ret)
		return ret;

	return th1520_reset_deassert(rcdev, id);
}

static int th1520_reset_status(struct reset_controller_dev *rcdev,
			       unsigned long id)
{
	struct th1520_reset *rc = th1520_reset_from(rcdev);
	void __iomem *reg = th1520_reset_reg(rc, id);
	u32 mask = th1520_reset_mask(rc, id);
	u32 value = readl(reg);

	return !(value & mask);
}

static const struct reset_control_ops th1520_reset_ops = {
	.assert		= th1520_reset_assert,
	.deassert	= th1520_reset_deassert,
	.reset		= th1520_reset_reset,
	.status		= th1520_reset_status,
};

static int __init th1520_reset_probe(struct platform_device *pdev)
{
	struct device *dev = &pdev->dev;
	const struct th1520_reset_subsys *subsys = device_get_match_data(dev);
	struct th1520_reset *rc;

	rc = devm_kzalloc(dev, sizeof(*rc), GFP_KERNEL);
	if (!rc)
		return -ENOMEM;

	rc->base = devm_platform_ioremap_resource(pdev, 0);
	if (IS_ERR(rc->base))
		return PTR_ERR(rc->base);

	rc->rcdev.ops = &th1520_reset_ops;
	rc->rcdev.owner = THIS_MODULE;
	rc->rcdev.nr_resets = subsys->nr_resets;
	rc->rcdev.dev = dev;
	rc->rcdev.of_node = dev->of_node;

	spin_lock_init(&rc->lock);

	rc->resets = subsys->resets;

	return devm_reset_controller_register(dev, &rc->rcdev);
}

static const struct of_device_id th1520_reset_match[] = {
	{ .compatible = "thead,th1520-reset-aon", .data = &th1520_aon_subsys },
	{ .compatible = "thead,th1520-reset-ap", .data = &th1520_ap_subsys },
	{ /* sentinel */ }
};

static struct platform_driver th1520_reset_driver = {
	.driver = {
		.name = "th1520-reset",
		.of_match_table = th1520_reset_match,
		.suppress_bind_attrs = true,
	},
};
builtin_platform_driver_probe(th1520_reset_driver, th1520_reset_probe);
